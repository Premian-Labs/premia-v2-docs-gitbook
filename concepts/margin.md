# Margin

## <mark style="color:blue;">Overview</mark>

Margin in of itself is a type of vault. It is built _on top_ of the base layer. This segregation from the base layer insures solvency and ability to guarantee payout as a settlement engine. Users who choose to utilize margin must do so through the margin vault. This experience is simplified for users of the Premia Interface or Premia v3 SDK. One of the major differences between using margin and using the base layer is that positions held by users on the base layer can be withdrawn and freely moved. Conversely, positions that utilize margin can not be withdrawn.

The margin vault contains a blend of attributes from traditional Reg-T and Portfolio Margin systems that provide _sell-side_ leverage. A risk-based model is used to assess user positions in an isolated fashion (per-position). In order for the base layer to always remain solvent, margin users must borrow capital from pool lenders, which is then used to _fully collateralize_ the exposure on the base layer.

Borrowers are in “first-loss” position relative to the lender. This means all losses incurred on a position are debited from a borrow before the lender takes on any risk. All profit is retained by the user borrowing capital, less capital usage fees (interest).

## <mark style="color:blue;">Providing Liquidity as a Lender</mark>

Lending markets are established exclusively for the purpose of providing capital to option underwriters, where each collateral type (eg. ETH, WBTC, USDC) has its own margin lending pool.

When depositing capital into a margin pool, each lender must select a deadline on which their capital is to be returned. A lender's capital can be borrowed at any time before the deadline (or indefinitely if no deadline is set). For example, if a lender's deadline is 30 days from now, this implies the lender's capital will be available for up to the next 30 days, and will only be used for options that expire between the current time and the deadline.

Any lender capital utilized in an option position is locked for up to the expiration of the position. Upon borrowing, a borrower pays an upfront interest-based commitment fee based on the utilization of the total available capital in the pool, up to the option's expiration. When a borrower successfully closes a position, each lender's capital is unlocked and immediately made available for further lending or withdrawal. At any time, lenders may withdraw any of their capital that is not being utilized in the pool.

A lender's capital may be utilized for multiple options, so long as each expiration date is prior to the lender's deadline. All lenders for a specific expiration share in lending fees pro-rata. Additionally, lenders split principal risk of liquidated option positions, if and only if the Reserve Fund (discussed [below](margin.md#reserve-fund)) cannot fully cover losses. When a lender's deadline is passed, their capital will be reserved for withdrawal and will no longer be available to be borrowed for margin.

If a borrower closes a position before maturity, they will be rebated with commitment fee claim tokens, enabling the user to claim any potential commitment fees generated by the returned capital, if borrowed again by another user prior to maturity.

## <mark style="color:blue;">Selling on Margin</mark>

### Lending Fee

In order to sell on margin, a user must borrow funds so that the position is fully collateralized. Borrowing these funds requires paying interest. Interest is payed _up-front when a trade is opened._ Any interest left over (ie. a position is closed before expiration) is credited back to the trader upon closing the trade in the form or rebate claim tokens, which do **not** affect lender returns. The lending fee sits between the prevailing risk-free rate, `R` and `R + .05`. The amount of reserves relative to the amount of margined open interest determines where the interest rate will be. In other words, the more risk the lenders are potentially exposed to, the higher the interest rate charged up to 5% over the risk-free rate.

For example, if there is 100 ETH in the ETH Reserve Fund, the first 100 short option positions opened on margin will borrow at the risk free rate. This is because there is no risk of loss to the lenders as any loss will be covered by the reserve fund. As the risk of loss to lenders becomes non-zero (the reserve fund capital becomes exposed), the interest rate will traverse to 10% to cover the risk of potential loss of their funds (as risk is transferred to lenders).

<figure><img src="../.gitbook/assets/Screenshot 2023-03-28 at 3.59.28 PM.png" alt=""><figcaption></figcaption></figure>

### Min Margin

Minimum Margin is the least amount of collateral a position needs to maintain before it will be liquidated. It is important to know that this is a _dynamic_ number and will change over the life of a margined position based of several factors.

### Dynamics of Min Margin

<mark style="color:orange;">Time</mark> → As a function of time (all else equal), the Min Margin will _decrease_ as an option gets closer to expiration.

<mark style="color:orange;">IV</mark> → As a function of IV (all else equal), the Min Margin will _increase_ when an option’s IV increases.

<mark style="color:orange;">Price</mark> → As a function of price (all else equal), the Min Margin will _increase_ when an option’s price increases.

{% hint style="info" %}
Under volatile market conditions, it is possible for margin to become temporarily unavailable for a given market (or option). If this were to happen, all positions that were opened using margin must be fully collateralized by users (or closed); otherwise positions will be liquidated. More technical details on the calculation method can be found in the [whitepaper](https://premia.finance/v3.pdf) under section _6 Margin_.
{% endhint %}

At all times a user can monitor the Minimum Margin requirement for a given position and in the future, users will be able to set alerts directly on the Premia Interface to avoid liquidation.

### Initial Margin

Initial Margin is the minimum amount of collateral that must be provided by a user in order to open a _new_ short option position using margin. It is set to 1.5x the Min Margin. This ensures users have a substantial risk buffer before a position can be liquidated, once it is opened.

## <mark style="color:blue;">Liquidation</mark>

Liquidations do not instantly occur automatically on-chain. One of the of the major challenges with on-chain liquidation is price distortion, which is a function of liquidity. The less liquidity there is in a given market, the more it will be impacted by a liquidation event creating negative feedback loops. To solve for this, we’ve implemented a Reserve Fund structure (discussed [next](margin.md#reserve-fund)), which will help prevent negative feedback loops and can offset risk exposures for lenders as it grows.

### Liquidation Trigger

Anyone can liquidate an at-risk position on-chain and collect a liquidation fee for doing so. The liquidator does _not_ take on position exposure. They merely act as a keeper, monitoring for positions that can be liquidated, and invoking the `liquidate_position` function for LP exposures and `liquidate_trade` for taker positions.

### Liquidation Fee

The fee that is rewarded to a liquidator is 0.3% of the total position value (capped at $10k USDC equivalent).

### Liquidated Positions

Liquidation events merely transfer ownership from the trader to the reserve fund. The position is then held by the reserve fund until expiration. _Traders who are liquidated lose their collateral (Minimum Margin) upon liquidation. Funds forfeited by the trader are then used to offset any potential loss._

{% hint style="info" %}
&#x20;_Any additional funds left after expiration are allocated to the reserve fund to cover future potential losses._
{% endhint %}

### Determining Market Value

Liquidations are determined based on an IV oracle which seeks to establish the fair market value of an option at any given point. This means that liquidations are not effected by pool prices. This has the added benefit of not triggering erroneous liquidations due to price wicks on the exchange. For further details on the IV Oracle, please see [here](oracles.md#iv-oracle).

## <mark style="color:blue;">Reserve Fund</mark>

Collateral in the Reserve Fund is meant to absorb the profit-or-loss of liquidated positions. Since lenders only provide capital to option positions that have times to maturity less than their deadline, the margin system is able to settle positions and abstract profit-or-loss variance from lenders before they are able to request a withdraw. _Simply stated, the Reserve Fund is in a first-loss position against lenders' principle._ Additionally, it is capable of distributing excess reserves as supplementary yield to lenders, akin to dividend payouts. If the Reserve Fund were to ever be insolvent, lenders' principle _could_ be exposed pro-rata to loss on liquidated positions.

{% hint style="info" %}
&#x20;Keep in mind, as the Reserve Fund’s available capital decreases, the interest rate provided to lenders (required to borrow additional capital) may increase (if not already at the ceiling rate) to compensate for additional potential risk.
{% endhint %}

In the event that reserve funds can not completely cover all (potential) losses, they are utilized in order of option expiration first. For options that have the same expiration, options are settled with reserve assets on a _first-come, first-settle basis_.
